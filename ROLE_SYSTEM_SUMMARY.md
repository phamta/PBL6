# ğŸ” Há»‡ thá»‘ng PhÃ¢n quyá»n PBL6 - HoÃ n chá»‰nh

## ğŸ“ **Tá»•ng quan**

ÄÃ£ thiáº¿t káº¿ vÃ  triá»ƒn khai há»‡ thá»‘ng phÃ¢n quyá»n hoÃ n chá»‰nh vá»›i 7 roles vÃ  permission-based access control.

## ğŸ‘¥ **7 Roles Ä‘Æ°á»£c Ä‘á»‹nh nghÄ©a**

### 1. **Admin CNTT** (`admin`)

**Vai trÃ²:** Quáº£n lÃ½ tÃ i khoáº£n & phÃ¢n quyá»n, cáº¥u hÃ¬nh há»‡ thá»‘ng
**Quyá»n háº¡n:**

- âœ… Quáº£n lÃ½ tÃ i khoáº£n (táº¡o, sá»­a, xÃ³a, phÃ¢n quyá»n)
- âœ… Cáº¥u hÃ¬nh há»‡ thá»‘ng
- âœ… Backup & nháº­t kÃ½ há»‡ thá»‘ng
- âœ… Truy cáº­p toÃ n bá»™ dá»¯ liá»‡u
- âœ… Táº¥t cáº£ quyá»n cá»§a cÃ¡c module

### 2. **NgÆ°á»i dÃ¹ng cÆ¡ sá»Ÿ** (`user`)

**Vai trÃ²:** CÃ¡n bá»™ Khoa/PhÃ²ng/Viá»‡n
**Quyá»n háº¡n:**

- âœ… Ná»™p há»“ sÆ¡ (Visa, MOU, Báº£n dá»‹ch, ÄoÃ n vÃ o)
- âœ… Theo dÃµi tráº¡ng thÃ¡i
- âœ… Bá»• sung thÃ´ng tin khi Ä‘Æ°á»£c yÃªu cáº§u
- âœ… Quáº£n lÃ½ khÃ¡ch quá»‘c táº¿ cá»§a Ä‘Æ¡n vá»‹ mÃ¬nh
- ğŸ”’ Chá»‰ xem dá»¯ liá»‡u Ä‘Æ¡n vá»‹

### 3. **Sinh viÃªn/Há»c viÃªn quá»‘c táº¿** (`student`)

**Vai trÃ²:** NgÆ°á»i dÃ¹ng cÃ¡ nhÃ¢n
**Quyá»n háº¡n:**

- âœ… ÄÄƒng kÃ½ gia háº¡n visa
- âœ… Upload há»“ sÆ¡, theo dÃµi tráº¡ng thÃ¡i
- âœ… Nháº­n thÃ´ng bÃ¡o nháº¯c háº¡n
- ğŸ”’ Chá»‰ xem dá»¯ liá»‡u cÃ¡ nhÃ¢n

### 4. **ChuyÃªn viÃªn HTQT/KHCN&ÄN** (`specialist`)

**Vai trÃ²:** Tiáº¿p nháº­n vÃ  xá»­ lÃ½ há»“ sÆ¡
**Quyá»n háº¡n:**

- âœ… Tiáº¿p nháº­n vÃ  kiá»ƒm tra há»“ sÆ¡
- âœ… YÃªu cáº§u bá»• sung, chá»‰nh sá»­a
- âœ… Duyá»‡t sÆ¡ bá»™ hoáº·c tá»« chá»‘i
- âœ… Xuáº¥t cÃ´ng vÄƒn (NA5/NA6, xÃ¡c nháº­n báº£n dá»‹ch)
- âœ… Thá»‘ng kÃª vÃ  bÃ¡o cÃ¡o
- âœ… Xem toÃ n bá»™ dá»¯ liá»‡u

### 5. **LÃ£nh Ä‘áº¡o PhÃ²ng HTQT/KHCN** (`manager`)

**Vai trÃ²:** PhÃª duyá»‡t chÃ­nh thá»©c
**Quyá»n háº¡n:**

- âœ… Xem toÃ n bá»™ há»“ sÆ¡ Ä‘Ã£ qua bÆ°á»›c kiá»ƒm tra
- âœ… PhÃª duyá»‡t hoáº·c tá»« chá»‘i chÃ­nh thá»©c
- âœ… Quáº£n lÃ½ bÃ¡o cÃ¡o tá»•ng há»£p
- âœ… KÃ½ MOU, cháº¥m dá»©t há»£p tÃ¡c
- âœ… Xuáº¥t bÃ¡o cÃ¡o Excel/PDF

### 6. **NgÆ°á»i dÃ¹ng tra cá»©u** (`viewer`)

**Vai trÃ²:** Xem dá»¯ liá»‡u cÃ´ng khai
**Quyá»n háº¡n:**

- âœ… Chá»‰ cÃ³ quyá»n xem dá»¯ liá»‡u Ä‘Ã£ cÃ´ng khai/Ä‘Æ°á»£c phÃ©p
- âœ… Xem danh sÃ¡ch MOU Ä‘Ã£ kÃ½
- âœ… Xem thá»‘ng kÃª bÃ¡o cÃ¡o
- ğŸ”’ KhÃ´ng cÃ³ quyá»n táº¡o/sá»­a

### 7. **Há»‡ thá»‘ng** (`system`)

**Vai trÃ²:** Bot tá»± Ä‘á»™ng
**Quyá»n háº¡n:**

- âœ… Gá»­i email nháº¯c háº¡n visa, MOU sáº¯p háº¿t hiá»‡u lá»±c
- âœ… Gá»­i thÃ´ng bÃ¡o dashboard
- âœ… Xem dá»¯ liá»‡u Ä‘á»ƒ xá»­ lÃ½ tá»± Ä‘á»™ng

## ğŸ”‘ **Permission System**

### **Cáº¥u trÃºc Permission**

```typescript
format: "module:action"
VÃ­ dá»¥: "mou:create", "visa:approve", "user:delete"
```

### **CÃ¡c nhÃ³m Permission chÃ­nh:**

- **User Management:** `user:create`, `user:read`, `user:update`, `user:delete`, `user:assign_role`
- **System:** `system:config`, `system:backup`, `system:logs`
- **Visa:** `visa:create`, `visa:read`, `visa:update`, `visa:review`, `visa:approve`
- **MOU:** `mou:create`, `mou:read`, `mou:update`, `mou:review`, `mou:approve`, `mou:sign`
- **Translation:** `translation:create`, `translation:read`, `translation:review`, `translation:certify`
- **Reports:** `report:view`, `report:export`, `report:stats`
- **Data Access:** `data:view_all`, `data:view_department`, `data:view_own`, `data:view_public`

## ğŸ—ï¸ **Backend Architecture**

### **Files Created/Updated:**

1. **Permission System:**

   - `src/common/enums/permission.enum.ts` - Permission definitions
   - `src/auth/guards/permissions.guard.ts` - Permission validation
   - `src/auth/decorators/permissions.decorator.ts` - Permission decorator
   - `src/auth/services/permission.service.ts` - Permission utilities

2. **Updated Controllers:**

   - `src/modules/user/user.controller.ts` - Permission-based access
   - `src/modules/mou/mou.controller.ts` - Permission-based access
   - `src/modules/report/report.controller.ts` - Permission-based access

3. **Database:**
   - `src/database/migrations/role-migration.sql` - Role migration script

### **Usage Examples:**

```typescript
// Controller permission check
@UseGuards(PermissionsGuard)
@Permissions(Permission.MOU_CREATE)
createMOU() { ... }

// Service permission check
@UseGuards(PermissionsGuard)
@Permissions(Permission.USER_ASSIGN_ROLE, Permission.USER_UPDATE)
assignRole() { ... }
```

## ğŸ¨ **Frontend Architecture**

### **Files Created:**

1. **Permission Hook:**
   - `src/hooks/usePermissions.ts` - Permission checking utilities
2. **Permission Components:**
   - `src/components/auth/PermissionGate.tsx` - Conditional rendering
3. **Admin Pages:**
   - `src/app/dashboard/admin/roles/page.tsx` - Role management interface

### **Usage Examples:**

```typescript
// Permission checking
const { can, hasPermission } = usePermissions();

if (can.createMOU()) {
  // Show create button
}

// Conditional rendering
<PermissionGate permission="mou:create">
  <CreateButton />
</PermissionGate>

// Role checking
<RoleGate roles={['admin', 'manager']}>
  <AdminPanel />
</RoleGate>
```

## ğŸš€ **Migration Strategy**

### **Role Mapping:**

- `KHOA` â†’ `MANAGER` (LÃ£nh Ä‘áº¡o PhÃ²ng)
- `PHONG` â†’ `SPECIALIST` (ChuyÃªn viÃªn)
- `USER` â†’ `USER` (giá»¯ nguyÃªn)
- `ADMIN` â†’ `ADMIN` (giá»¯ nguyÃªn)

### **Migration Steps:**

1. âœ… Update UserRole enum
2. âœ… Create Permission system
3. âœ… Update Controllers to use Permissions
4. âœ… Create Frontend permission system
5. ğŸ”„ Run database migration
6. ğŸ”„ Update remaining service files
7. ğŸ”„ Test all modules

## ğŸ“Š **Role-Permission Matrix**

| Module              | Admin   | User | Student | Specialist | Manager | Viewer | System |
| ------------------- | ------- | ---- | ------- | ---------- | ------- | ------ | ------ |
| **User Management** | âœ… Full | âŒ   | âŒ      | âŒ         | âŒ      | âŒ     | âŒ     |
| **Visa Create**     | âœ…      | âœ…   | âœ…      | âŒ         | âŒ      | âŒ     | âŒ     |
| **Visa Review**     | âœ…      | âŒ   | âŒ      | âœ…         | âŒ      | âŒ     | âŒ     |
| **Visa Approve**    | âœ…      | âŒ   | âŒ      | âŒ         | âœ…      | âŒ     | âŒ     |
| **MOU Create**      | âœ…      | âœ…   | âŒ      | âŒ         | âŒ      | âŒ     | âŒ     |
| **MOU Review**      | âœ…      | âŒ   | âŒ      | âœ…         | âŒ      | âŒ     | âŒ     |
| **MOU Approve**     | âœ…      | âŒ   | âŒ      | âŒ         | âœ…      | âŒ     | âŒ     |
| **MOU Sign**        | âœ…      | âŒ   | âŒ      | âŒ         | âœ…      | âŒ     | âŒ     |
| **Reports Export**  | âœ…      | âŒ   | âŒ      | âœ…         | âœ…      | âŒ     | âŒ     |
| **System Config**   | âœ…      | âŒ   | âŒ      | âŒ         | âŒ      | âŒ     | âŒ     |
| **View Data**       | All     | Dept | Own     | All        | All     | Public | All    |

## ğŸ”§ **Next Steps**

1. **Complete Migration:**

   ```sql
   -- Run migration script
   psql -d your_database < src/database/migrations/role-migration.sql
   ```

2. **Update Remaining Files:**

   - Visa extension services
   - Translation services
   - Visitor services
   - Other controllers

3. **Test All Modules:**

   - User authentication
   - Permission validation
   - Role-based access
   - API endpoints

4. **Frontend Integration:**
   - Update navigation based on permissions
   - Hide/show buttons based on roles
   - Create role management interface

## âœ… **Benefits Achieved**

1. **Granular Control:** Permission-based thay vÃ¬ role-based Ä‘Æ¡n thuáº§n
2. **Scalability:** Dá»… dÃ ng thÃªm permissions má»›i
3. **Security:** Kiá»ƒm soÃ¡t cháº·t cháº½ tá»«ng hÃ nh Ä‘á»™ng
4. **Maintainability:** Code rÃµ rÃ ng, dá»… báº£o trÃ¬
5. **User Experience:** Interface phÃ¹ há»£p vá»›i tá»«ng role
6. **Audit Trail:** Theo dÃµi Ä‘Æ°á»£c quyá»n háº¡n cá»§a tá»«ng user

## ğŸ¯ **Status**

- âœ… **Backend Permission System** - HoÃ n thÃ nh
- âœ… **Frontend Permission Hooks** - HoÃ n thÃ nh
- âœ… **Role Management Interface** - HoÃ n thÃ nh
- âœ… **Migration Scripts** - HoÃ n thÃ nh
- ğŸ”„ **File Updates** - Äang tiáº¿n hÃ nh
- â³ **Testing** - Chá» hoÃ n thiá»‡n
- â³ **Deployment** - Chá» testing

Há»‡ thá»‘ng Ä‘Ã£ sáºµn sÃ ng Ä‘á»ƒ test vÃ  deploy vá»›i Ä‘áº§y Ä‘á»§ 7 roles vÃ  permission system máº¡nh máº½!
